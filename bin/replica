#!bin/pico lib.l
# 30aug05abu
# Use: bin/replica <dbFile> <port> <keyFile> [<journal>]
#    : bin/ssl <host> 443 <port>/@replica <keyFile> <journal> 60

(load "@lib/misc.l" "@lib/http.l")

(allowed NIL "@replica")

(argv *DbFile *Port *SSLKey *Journal)

(setq
   *Port (format *Port)
   *SSLKey (in *SSLKey (read)) )

(de replica ()
   (protect
      (and
         (= (read) *SSLKey)
         (read)
         (out (tmp 'replica) (echo 1 @))
         (prin (peek))
         (flush)
         (ctl *DbFile (in (tmp 'replica) (journal))) ) ) )

(pool *DbFile *Journal)
(server *Port)
